name: Build Shared Libraries

on: [push, pull_request]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    # We use 'macos-15' (which supports Intel/x86_64) as per your logs
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            output_file: libChessLib.so
          - os: windows-latest
            output_file: ChessLib.dll
          - os: macos-15
            output_file: libChessLib.dylib

    steps:
    - uses: actions/checkout@v4

    # --- LINUX DEPENDENCIES ---
    - name: Install Linux Deps
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libxrandr-dev libxcursor-dev libudev-dev libopenal-dev libflac-dev libvorbis-dev libgl1-mesa-dev libegl1-mesa-dev libfreetype6-dev libx11-dev

    # --- MAC DEPENDENCIES ---
    # We do NOT use vcpkg anymore. SFML's FetchContent will handle it.
    # Standard Xcode tools (already on the runner) are enough.

    # --- CONFIGURE CMAKE ---
    - name: Configure CMake
      run: |
        if [ "$RUNNER_OS" == "macOS" ]; then
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release "-DCMAKE_OSX_ARCHITECTURES=x86_64;arm64"
        else
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        fi
      shell: bash

    # --- BUILD ---
    - name: Build
      run: cmake --build build --config Release

    # --- UPLOAD ARTIFACTS ---
    - name: Upload Library
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.output_file }}
        path: |
          build/${{ matrix.output_file }}
          build/Release/${{ matrix.output_file }}
