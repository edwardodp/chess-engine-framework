name: Build Shared Libraries

on: [push, pull_request]

jobs:
  build:
    name: Build ${{ matrix.output_file }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            output_file: libChessLib.so
            
          # Windows
          - os: windows-latest
            output_file: ChessLib.dll
            
          # Mac - Apple Silicon (M1/M2/M3)
          - os: macos-latest
            output_file: libChessLib_arm64.dylib
            
          # Mac - Intel
          - os: macos-15  # Explicitly use the Intel runner
            output_file: libChessLib_intel.dylib

    steps:
    - uses: actions/checkout@v4

    # --- LINUX SETUP ---
    - name: Install Linux Deps
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libxrandr-dev libxcursor-dev libudev-dev libopenal-dev libflac-dev libvorbis-dev libgl1-mesa-dev libegl1-mesa-dev libfreetype6-dev libx11-dev

    # --- BUILD ---
    - name: Configure CMake
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    # --- RENAME (Mac Only) ---
    # Since CMake outputs "libChessLib.dylib" by default, we rename it to match the matrix
    - name: Rename Mac Binary
      if: runner.os == 'macOS'
      run: mv build/libChessLib.dylib build/${{ matrix.output_file }}

    # --- UPLOAD ---
    - name: Upload Library
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.output_file }}
        path: |
          build/${{ matrix.output_file }}
          build/Release/${{ matrix.output_file }}
